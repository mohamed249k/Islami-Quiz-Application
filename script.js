// Islamic Quiz Application - Vanilla JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // App State
    const appState = {
        currentScreen: 'welcome',
        selectedLevel: null,
        currentQuestionIndex: 0,
        score: 0,
        correctAnswers: 0,
        timer: null,
        timeLeft: 0,
        totalTime: 0,
        userAnswers: [],
        badges: [],
        isDarkMode: localStorage.getItem('isDarkMode') === 'true'
    };
    
    // Questions Database - 100 Islamic questions organized by level
    const questionsDatabase = {
        // Level 1: Very Easy (20 questions)
        1: [
            {
                id: 1,
                question: "كم عدد أركان الإسلام؟",
                options: ["ثلاثة", "أربعة", "خمسة", "ستة"],
                correctAnswer: 2,
                explanation: "أركان الإسلام خمسة: الشهادتان، إقام الصلاة، إيتاء الزكاة، صوم رمضان، حج البيت من استطاع إليه سبيلاً."
            },
            {
                id: 2,
                question: "ما هو أول أركان الإسلام؟",
                options: ["الصلاة", "الشهادتان", "الزكاة", "الصوم"],
                correctAnswer: 1,
                explanation: "أول أركان الإسلام هو الشهادتان: شهادة أن لا إله إلا الله وأن محمداً رسول الله."
            },
            {
                id: 3,
                question: "من هو آخر الأنبياء والمرسلين؟",
                options: ["موسى عليه السلام", "عيسى عليه السلام", "محمد صلى الله عليه وسلم", "إبراهيم عليه السلام"],
                correctAnswer: 2,
                explanation: "سيدنا محمد صلى الله عليه وسلم هو خاتم الأنبياء والمرسلين، لا نبي بعده."
            },
            {
                id: 4,
                question: "ما هي الصلاة التي يزيد عدد ركعاتها في رمضان؟",
                options: ["الظهر", "العصر", "المغرب", "التراويح"],
                correctAnswer: 3,
                explanation: "صلاة التراويح هي سنة عن النبي صلى الله عليه وسلم وتزيد في شهر رمضان المبارك."
            },
            {
                id: 5,
                question: "ما هو شهر الصيام في الإسلام؟",
                options: ["شوال", "رمضان", "محرم", "ذو الحجة"],
                correctAnswer: 1,
                explanation: "شهر رمضان هو شهر الصيام، وهو الركن الرابع من أركان الإسلام."
            },
            {
                id: 6,
                question: "كم عدد الركعات في صلاة الفجر؟",
                options: ["ركعتان", "ثلاث ركعات", "أربع ركعات", "خمس ركعات"],
                correctAnswer: 0,
                explanation: "صلاة الفجر ركعتان، وهي الصلاة الوحيدة التي لا يجهر فيها الإمام بالقراءة في الركعة الثانية."
            },
            {
                id: 7,
                question: "ما هي السورة التي تسمى قلب القرآن؟",
                options: ["البقرة", "الفاتحة", "يس", "الكهف"],
                correctAnswer: 2,
                explanation: "سورة يس تسمى قلب القرآن لما فيها من عظيم المعاني والمواعظ."
            },
            {
                id: 8,
                question: "كم عدد أيام الحج الأساسية؟",
                options: ["ثلاثة أيام", "أربعة أيام", "خمسة أيام", "ستة أيام"],
                correctAnswer: 2,
                explanation: "أيام الحج الأساسية هي ثلاثة أيام: يوم التروية، يوم عرفة، ويوم النحر."
            },
            {
                id: 9,
                question: "ما هو أول ما نزل من القرآن الكريم؟",
                options: ["سورة الفاتحة", "سورة العلق", "سورة المدثر", "سورة المزمل"],
                correctAnswer: 1,
                explanation: "أول ما نزل من القرآن الكريم هو أول آيات سورة العلق: 'اقرأ باسم ربك الذي خلق'."
            },
            {
                id: 10,
                question: "من هو أول رسول أرسله الله إلى البشر؟",
                options: ["آدم عليه السلام", "نوح عليه السلام", "إبراهيم عليه السلام", "موسى عليه السلام"],
                correctAnswer: 1,
                explanation: "نوح عليه السلام هو أول رسول أرسله الله إلى البشر، وقد دعا قومه 950 سنة."
            },
            {
                id: 11,
                question: "ما هو أعلى مراتب الجنة؟",
                options: ["الجنة", "الفردوس", "الخلد", "الوسيلة"],
                correctAnswer: 1,
                explanation: "الفردوس هي أعلى مراتب الجنة، وتقع تحت عرش الرحمن."
            },
            {
                id: 12,
                question: "ما هي الكتب السماوية التي يجب الإيمان بها؟",
                options: ["القرآن فقط", "القرآن والإنجيل", "القرآن والتوراة والإنجيل والزبور", "جميع الكتب السماوية"],
                correctAnswer: 2,
                explanation: "يجب الإيمان بجميع الكتب السماوية التي أنزلها الله على رسله، ومنها القرآن والتوراة والإنجيل والزبور."
            },
            {
                id: 13,
                question: "من هم الذين يجب عليهم الصيام في رمضان؟",
                options: ["الرجال فقط", "النساء فقط", "المسلمون البالغون العاقلون", "جميع المسلمين"],
                correctAnswer: 2,
                explanation: "يجب الصيام على كل مسلم بالغ عاقل مقيم قادر على الصيام."
            },
            {
                id: 14,
                question: "ما هي ليلة القدر؟",
                options: ["ليلة النصف من شعبان", "ليلة الإسراء والمعراج", "ليلة مباركة في رمضان", "ليلة عيد الفطر"],
                correctAnswer: 2,
                explanation: "ليلة القدر هي ليلة مباركة في العشر الأواخر من رمضان، وهي خير من ألف شهر."
            },
            {
                id: 15,
                question: "ما هو الركن الذي لا يتم الإسلام إلا به؟",
                options: ["الصلاة", "الشهادتان", "الزكاة", "الحج"],
                correctAnswer: 1,
                explanation: "الشهادتان هما الركن الذي لا يتم الإسلام إلا به، فمن نطق بهما دخل في الإسلام."
            },
            {
                id: 16,
                question: "كم عدد سور القرآن الكريم؟",
                options: ["100 سورة", "110 سور", "114 سورة", "120 سورة"],
                correctAnswer: 2,
                explanation: "عدد سور القرآن الكريم 114 سورة، منها 86 مكية و28 مدنية."
            },
            {
                id: 17,
                question: "ما هي الصلاة التي يبدأ بها وقت الصلاة؟",
                options: ["الفجر", "الظهر", "المغرب", "العشاء"],
                correctAnswer: 0,
                explanation: "صلاة الفجر هي أول الصلوات الخمس التي فرضها الله تعالى."
            },
            {
                id: 18,
                question: "ما هو اليوم الذي خلق فيه آدم عليه السلام؟",
                options: ["الجمعة", "السبت", "الأحد", "الاثنين"],
                correctAnswer: 0,
                explanation: "خلق الله آدم عليه السلام يوم الجمعة، وهو خير يوم طلعت فيه الشمس."
            },
            {
                id: 19,
                question: "ما هي الصلاة التي تسمى الصلاة الوسطى؟",
                options: ["الفجر", "الظهر", "العصر", "المغرب"],
                correctAnswer: 2,
                explanation: "صلاة العصر تسمى الصلاة الوسطى، وقد ورد الحث على المحافظة عليها في القرآن."
            },
            {
                id: 20,
                question: "من هو النبي الذي ابتلعه الحوت؟",
                options: ["أيوب عليه السلام", "يونس عليه السلام", "يوسف عليه السلام", "إدريس عليه السلام"],
                correctAnswer: 1,
                explanation: "النبي يونس عليه السلام هو الذي ابتلعه الحوت لما ترك قومه دون إذن من الله."
            }
        ],
        
        // Level 2: Easy (20 questions)
        2: [
            {
                id: 21,
                question: "كم عدد أركان الإيمان؟",
                options: ["أربعة", "خمسة", "ستة", "سبعة"],
                correctAnswer: 2,
                explanation: "أركان الإيمان ستة: الإيمان بالله، وملائكته، وكتبه، ورسله، واليوم الآخر، والقدر خيره وشره."
            },
            {
                id: 22,
                question: "من هو النبي الذي سمي بخليل الله؟",
                options: ["موسى عليه السلام", "إبراهيم عليه السلام", "محمد صلى الله عليه وسلم", "عيسى عليه السلام"],
                correctAnswer: 1,
                explanation: "إبراهيم عليه السلام سمي بخليل الله لأنه كان حبيب الله وخاصته."
            },
            {
                id: 23,
                question: "ما هي السورة التي تسمى عروس القرآن؟",
                options: ["البقرة", "الرحمن", "الكهف", "يس"],
                correctAnswer: 1,
                explanation: "سورة الرحمن تسمى عروس القرآن لما فيها من جمال الأسلوب وعظمة المعاني."
            },
            {
                id: 24,
                question: "من هو أول من أسلم من الصبيان؟",
                options: ["علي بن أبي طالب", "الزبير بن العوام", "عبدالله بن مسعود", "زيد بن حارثة"],
                correctAnswer: 0,
                explanation: "علي بن أبي طالب رضي الله عنه هو أول من أسلم من الصبيان، وكان عمره عشر سنين."
            },
            {
                id: 25,
                question: "ما هي السورة التي تعدل ثلث القرآن؟",
                options: ["الإخلاص", "الفلق", "الناس", "الكوثر"],
                correctAnswer: 0,
                explanation: "سورة الإخلاص تعدل ثلث القرآن لأنها تتناول توحيد الله تعالى."
            },
            {
                id: 26,
                question: "كم عدد المرات التي فرضت فيها الصلاة في اليوم والليلة؟",
                options: ["ثلاث مرات", "أربع مرات", "خمس مرات", "ست مرات"],
                correctAnswer: 2,
                explanation: "فرضت الصلاة خمس مرات في اليوم والليلة في ليلة الإسراء والمعراج."
            },
            {
                id: 27,
                question: "من هو الصحابي الملقب بسيف الله المسلول؟",
                options: ["خالد بن الوليد", "عمر بن الخطاب", "حمزة بن عبد المطلب", "أبو بكر الصديق"],
                correctAnswer: 0,
                explanation: "خالد بن الوليد رضي الله عنه لقب بسيف الله المسلول لشجاعته وبطولاته في الغزوات."
            },
            {
                id: 28,
                question: "ما هي أعظم سورة في القرآن؟",
                options: ["البقرة", "الفاتحة", "الكهف", "يس"],
                correctAnswer: 1,
                explanation: "سورة الفاتحة هي أعظم سورة في القرآن، وتسمى أم القرآن."
            },
            {
                id: 29,
                question: "من هو النبي الذي لقب بكليم الله؟",
                options: ["إبراهيم عليه السلام", "موسى عليه السلام", "عيسى عليه السلام", "محمد صلى الله عليه وسلم"],
                correctAnswer: 1,
                explanation: "موسى عليه السلام لقب بكليم الله لأنه كلمه الله تعالى بدون واسطة."
            },
            {
                id: 30,
                question: "ما هي أول غزوة في الإسلام؟",
                options: ["بدر", "أحد", "الخندق", "الأبواء"],
                correctAnswer: 3,
                explanation: "غزوة الأبواء (ودان) هي أول غزوة خرج فيها النبي صلى الله عليه وسلم بنفسه."
            },
            {
                id: 31,
                question: "من هو أول من جمع القرآن في مصحف واحد؟",
                options: ["أبو بكر الصديق", "عمر بن الخطاب", "عثمان بن عفان", "علي بن أبي طالب"],
                correctAnswer: 0,
                explanation: "أبو بكر الصديق رضي الله عنه هو أول من جمع القرآن في مصحف واحد بعد استشارة عمر بن الخطاب."
            },
            {
                id: 32,
                question: "ما هي الصلاة التي ليس لها ركوع ولا سجود؟",
                options: ["صلاة الكسوف", "صلاة الاستسقاء", "صلاة الجنازة", "صلاة الخوف"],
                correctAnswer: 2,
                explanation: "صلاة الجنازة هي الصلاة الوحيدة التي ليس لها ركوع ولا سجود."
            },
            {
                id: 33,
                question: "من هي أول امرأة أسلمت؟",
                options: ["خديجة بنت خويلد", "فاطمة الزهراء", "عائشة بنت أبي بكر", "سمية بنت خياط"],
                correctAnswer: 0,
                explanation: "خديجة بنت خويلد رضي الله عنها هي أول امرأة أسلمت، وكانت أول من آمن بالنبي صلى الله عليه وسلم."
            },
            {
                id: 34,
                question: "ما هي السورة التي تبدأ ب 'قل أعوذ برب الفلق'؟",
                options: ["الناس", "الفلق", "الإخلاص", "الكوثر"],
                correctAnswer: 1,
                explanation: "سورة الفلق هي التي تبدأ ب 'قل أعوذ برب الفلق'، وهي من المعوذات."
            },
            {
                id: 35,
                question: "كم عدد الأعوام التي عاشها النبي صلى الله عليه وسلم في مكة بعد البعثة؟",
                options: ["10 سنوات", "13 سنة", "15 سنة", "18 سنة"],
                correctAnswer: 1,
                explanation: "عاش النبي صلى الله عليه وسلم في مكة بعد البعثة 13 سنة يدعو الناس إلى الإسلام."
            },
            {
                id: 36,
                question: "من هو النبي الذي أرسل إلى قوم عاد؟",
                options: ["هود عليه السلام", "صالح عليه السلام", "لوط عليه السلام", "شعيب عليه السلام"],
                correctAnswer: 0,
                explanation: "هود عليه السلام أرسل إلى قوم عاد الذين كانوا يسكنون الأحقاف."
            },
            {
                id: 37,
                question: "ما هي العمرة؟",
                options: ["الحج الصغير", "زيارة المسجد النبوي", "زيارة المسجد الحرام", "الطواف بالكعبة والسعي بين الصفا والمروة"],
                correctAnswer: 3,
                explanation: "العمرة هي زيارة المسجد الحرام للطواف بالكعبة والسعي بين الصفا والمروة مع الإحرام."
            },
            {
                id: 38,
                question: "من هو الصحابي الذي اهتز لموته عرش الرحمن؟",
                options: ["أبو بكر الصديق", "عمر بن الخطاب", "عثمان بن عفان", "سعد بن معاذ"],
                correctAnswer: 3,
                explanation: "سعد بن معاذ رضي الله عنه هو الصحابي الذي اهتز لموته عرش الرحمن فرحًا بدخوله الجنة."
            },
            {
                id: 39,
                question: "ما هي السورة التي نزلت في يهود بني النضير؟",
                options: ["البقرة", "النساء", "المائدة", "الحشر"],
                correctAnswer: 3,
                explanation: "سورة الحشر نزلت في يهود بني النضير بعد غزوة بني النضير."
            },
            {
                id: 40,
                question: "من هو النبي الذي ابتلي بالمرض فصبر؟",
                options: ["أيوب عليه السلام", "يعقوب عليه السلام", "يونس عليه السلام", "إبراهيم عليه السلام"],
                correctAnswer: 0,
                explanation: "أيوب عليه السلام هو النبي الذي ابتلي بالمرض الشديد فصبر واحتسب حتى عافاه الله."
            }
        ],
        
        // Level 3: Medium (20 questions)
        3: [
            {
                id: 41,
                question: "ما هي السورة التي تسمى بسورة النساء الصغرى؟",
                options: ["الطلاق", "التحريم", "الطلاق والتحريم", "الطلاق فقط"],
                correctAnswer: 0,
                explanation: "سورة الطلاق تسمى بسورة النساء الصغرى لكثرة ما فيها من أحكام النساء."
            },
            {
                id: 42,
                question: "من هو الصحابي الذي لقب بترجمان القرآن؟",
                options: ["عبدالله بن عباس", "عبدالله بن مسعود", "زيد بن ثابت", "أبي بن كعب"],
                correctAnswer: 0,
                explanation: "عبدالله بن عباس رضي الله عنهما لقب بترجمان القرآن لحسن فهمه وتفسيره للقرآن."
            },
            {
                id: 43,
                question: "كم عدد آيات سورة البقرة؟",
                options: ["255 آية", "286 آية", "300 آية", "200 آية"],
                correctAnswer: 1,
                explanation: "سورة البقرة تحتوي على 286 آية، وهي أطول سورة في القرآن الكريم."
            },
            {
                id: 44,
                question: "ما هي السور التي تبدأ ب 'الحمد لله'؟",
                options: ["الفاتحة والأنعام والكهف وسبأ وفاطر", "الفاتحة والبقرة وآل عمران والنساء والمائدة", "الفاتحة فقط", "الفاتحة والبقرة وآل عمران"],
                correctAnswer: 0,
                explanation: "السور التي تبدأ ب 'الحمد لله' هي: الفاتحة، الأنعام، الكهف، سبأ، فاطر."
            },
            {
                id: 45,
                question: "من هو أول من أذن في الإسلام؟",
                options: ["بلال بن رباح", "عمر بن الخطاب", "أبو بكر الصديق", "علي بن أبي طالب"],
                correctAnswer: 0,
                explanation: "بلال بن رباح رضي الله عنه هو أول مؤذن في الإسلام، وقد اختاره النبي صلى الله عليه وسلم لأذانه."
            },
            {
                id: 46,
                question: "ما هي الغزوة التي وقعت في السنة التاسعة للهجرة؟",
                options: ["غزوة تبوك", "غزوة حنين", "غزوة الخندق", "غزوة بدر"],
                correctAnswer: 0,
                explanation: "غزوة تبوك وقعت في السنة التاسعة للهجرة، وكانت آخر غزوات النبي صلى الله عليه وسلم."
            },
            {
                id: 47,
                question: "كم عدد السنوات بين بناء إبراهيم للكعبة وبعثة محمد صلى الله عليه وسلم؟",
                options: ["2000 سنة", "2500 سنة", "3000 سنة", "لم يذكر العدد تحديدًا"],
                correctAnswer: 1,
                explanation: "بين بناء إبراهيم للكعبة وبعثة محمد صلى الله عليه وسلم حوالي 2500 سنة."
            },
            {
                id: 48,
                question: "من هو النبي الذي قال عنه الله 'واذكر في الكتاب إدريس'؟",
                options: ["إدريس عليه السلام", "إبراهيم عليه السلام", "إسماعيل عليه السلام", "إسحاق عليه السلام"],
                correctAnswer: 0,
                explanation: "النبي إدريس عليه السلام هو المذكور في القرآن في سورة مريم بقوله تعالى 'واذكر في الكتاب إدريس'."
            },
            {
                id: 49,
                question: "ما هي السورة التي تسمى قلب القرآن؟",
                options: ["البقرة", "الفاتحة", "يس", "الكهف"],
                correctAnswer: 2,
                explanation: "سورة يس تسمى قلب القرآن لما فيها من عظيم المعاني والمواعظ."
            },
            {
                id: 50,
                question: "من هي المرأة التي تزوجها النبي صلى الله عليه وسلم وهي بكر؟",
                options: ["خديجة بنت خويلد", "سودة بنت زمعة", "عائشة بنت أبي بكر", "حفصة بنت عمر"],
                correctAnswer: 2,
                explanation: "عائشة بنت أبي بكر رضي الله عنها هي المرأة الوحيدة التي تزوجها النبي صلى الله عليه وسلم وهي بكر."
            },
            {
                id: 51,
                question: "ما هي أول معركة بحرية في الإسلام؟",
                options: ["معركة ذات الصواري", "معركة اليرموك", "معركة القادسية", "معركة نهاوند"],
                correctAnswer: 0,
                explanation: "معركة ذات الصواري هي أول معركة بحرية في الإسلام، وقعت في عهد عثمان بن عفان."
            },
            {
                id: 52,
                question: "من هو الصحابي الذي دفن بجوار النبي صلى الله عليه وسلم؟",
                options: ["أبو بكر الصديق وعمر بن الخطاب", "أبو بكر الصديق فقط", "عمر بن الخطاب فقط", "أبو بكر الصديق وعمر بن الخطاب وعثمان بن عفان"],
                correctAnswer: 0,
                explanation: "أبو بكر الصديق وعمر بن الخطاب رضي الله عنهما دفنا بجوار النبي صلى الله عليه وسلم في حجرة عائشة."
            },
            {
                id: 53,
                question: "ما هي السورة التي نزلت دفعة واحدة؟",
                options: ["الفاتحة", "الأنعام", "الكهف", "المرسلات"],
                correctAnswer: 1,
                explanation: "سورة الأنعام نزلت دفعة واحدة، ومعها سبعون ألف ملك."
            },
            {
                id: 54,
                question: "من هو أول من سل سيفًا في سبيل الله؟",
                options: ["الزبير بن العوام", "حمزة بن عبد المطلب", "علي بن أبي طالب", "أبو بكر الصديق"],
                correctAnswer: 0,
                explanation: "الزبير بن العوام رضي الله عنه هو أول من سل سيفًا في سبيل الله دفاعًا عن الإسلام."
            },
            {
                id: 55,
                question: "ما هي السورة التي تسمى سورة القتال؟",
                options: ["الأنفال", "التوبة", "محمد", "الفتح"],
                correctAnswer: 2,
                explanation: "سورة محمد تسمى سورة القتال لكثرة ما فيها من أحكام الجهاد والقتال في سبيل الله."
            },
            {
                id: 56,
                question: "من هو الصحابي الذي أسلم على يديه عمر بن الخطاب؟",
                options: ["خباب بن الأرت", "سعيد بن زيد", "عبدالله بن مسعود", "بلال بن رباح"],
                correctAnswer: 1,
                explanation: "سعيد بن زيد رضي الله عنه هو الصحابي الذي أسلم على يديه عمر بن الخطاب، وكان صهره."
            },
            {
                id: 57,
                question: "ما هي السورة التي لم تبدأ ببسم الله الرحمن الرحيم؟",
                options: ["الفاتحة", "البقرة", "التوبة", "النمل"],
                correctAnswer: 2,
                explanation: "سورة التوبة هي السورة الوحيدة في القرآن التي لم تبدأ ببسم الله الرحمن الرحيم."
            },
            {
                id: 58,
                question: "من هو النبي الذي ذكر في القرآن أنه كان يصنع من الطين طيرًا؟",
                options: ["إبراهيم عليه السلام", "عيسى عليه السلام", "سليمان عليه السلام", "داود عليه السلام"],
                correctAnswer: 1,
                explanation: "عيسى عليه السلام هو النبي الذي كان يصنع من الطين كهيئة الطير فينفخ فيها فتكون طيرًا بإذن الله."
            },
            {
                id: 59,
                question: "ما هي آخر آية نزلت من القرآن الكريم؟",
                options: ["آية الربا", "آية الكلالة", "آية الدين", "آية البراءة"],
                correctAnswer: 1,
                explanation: "آية الكلالة في سورة النساء هي آخر آية نزلت من القرآن الكريم حسب بعض الروايات."
            },
            {
                id: 60,
                question: "من هو الصحابي الذي شهد له النبي صلى الله عليه وسلم بالجنة وهو حي؟",
                options: ["عمر بن الخطاب", "عثمان بن عفان", "طلحة بن عبيد الله", "الزبير بن العوام"],
                correctAnswer: 2,
                explanation: "طلحة بن عبيد الله رضي الله عنه هو أحد العشرة المبشرين بالجنة، وقد شهد له النبي صلى الله عليه وسلم بالجنة."
            }
        ],
        
        // Level 4: Hard (20 questions)
        4: [
            {
                id: 61,
                question: "ما هي السورة التي تسمى 'المنقذة'؟",
                options: ["الملك", "الواقعة", "السجدة", "الدخان"],
                correctAnswer: 0,
                explanation: "سورة الملك تسمى 'المنقذة' لأنها تنقذ قارئها من عذاب القبر."
            },
            {
                id: 62,
                question: "من هو الصحابي الذي قال عنه النبي 'لكل نبي حواري، وحواري الزبير'؟",
                options: ["الزبير بن العوام", "سعد بن أبي وقاص", "عبدالرحمن بن عوف", "طلحة بن عبيد الله"],
                correctAnswer: 0,
                explanation: "الزبير بن العوام رضي الله عنه هو حواري النبي صلى الله عليه وسلم، كما كان الحواريون لنبي الله عيسى عليه السلام."
            },
            {
                id: 63,
                question: "ما هي السورة التي تسمى 'الفاضحة'؟",
                options: ["التوبة", "الحجرات", "المنافقون", "التغابن"],
                correctAnswer: 0,
                explanation: "سورة التوبة تسمى 'الفاضحة' لأنها فضحت المنافقين وأحوالهم."
            },
            {
                id: 64,
                question: "من هو أول من استشهد في الإسلام؟",
                options: ["سمية بنت خياط", "ياسر بن عامر", "عمار بن ياسر", "بلال بن رباح"],
                correctAnswer: 0,
                explanation: "سمية بنت خياط رضي الله عنها هي أول من استشهد في الإسلام، وهي أم عمار بن ياسر."
            },
            {
                id: 65,
                question: "ما هي السورة التي تسمى 'سورة الحواريين'؟",
                options: ["الصف", "الجمعة", "المنافقون", "التغابن"],
                correctAnswer: 0,
                explanation: "سورة الصف تسمى 'سورة الحواريين' لورود ذكر الحواريين فيها."
            },
            {
                id: 66,
                question: "من هو الصحابي الذي كانت تستحي منه الملائكة؟",
                options: ["عثمان بن عفان", "عمر بن الخطاب", "أبو بكر الصديق", "علي بن أبي طالب"],
                correctAnswer: 0,
                explanation: "عثمان بن عفان رضي الله عنه كان تستحي منه الملائكة لحيائه الشديد."
            },
            {
                id: 67,
                question: "ما هي السورة التي تسمى 'العقود'؟",
                options: ["المائدة", "النساء", "البقرة", "آل عمران"],
                correctAnswer: 0,
                explanation: "سورة المائدة تسمى 'العقود' لأنها تبدأ بالأمر بالوفاء بالعقود."
            },
            {
                id: 68,
                question: "من هو الصحابي الذي دعا له النبي 'اللهم علمه الكتاب'؟",
                options: ["زيد بن ثابت", "معاذ بن جبل", "أبي بن كعب", "عبدالله بن عباس"],
                correctAnswer: 3,
                explanation: "عبدالله بن عباس رضي الله عنهما دعا له النبي صلى الله عليه وسلم 'اللهم علمه الكتاب' فصار ترجمان القرآن."
            },
            {
                id: 69,
                question: "ما هي السورة التي تسمى 'سورة النبي'؟",
                options: ["التحريم", "الأحزاب", "محمد", "الفتح"],
                correctAnswer: 1,
                explanation: "سورة الأحزاب تسمى 'سورة النبي' لكثرة ما ورد فيها من أحكام تتعلق بالنبي صلى الله عليه وسلم."
            },
            {
                id: 70,
                question: "من هو الصحابي الذي اهتزت لموته مدائن كسرى؟",
                options: ["سعد بن أبي وقاص", "خالد بن الوليد", "عمرو بن العاص", "المقداد بن الأسود"],
                correctAnswer: 0,
                explanation: "سعد بن أبي وقاص رضي الله عنه هو الصحابي الذي اهتزت لموته مدائن كسرى."
            },
            {
                id: 71,
                question: "ما هي السورة التي تسمى 'المجادلة'؟",
                options: ["المجادلة", "الممتحنة", "الطلاق", "التحريم"],
                correctAnswer: 0,
                explanation: "سورة المجادلة تسمى بهذا الاسم لورود قصة المرأة التي جادلت النبي صلى الله عليه وسلم في زوجها."
            },
            {
                id: 72,
                question: "من هو الصحابي الذي صلى إلى القبلتين؟",
                options: ["بلال بن رباح", "عمار بن ياسر", "سلمان الفارسي", "كل الصحابة"],
                correctAnswer: 3,
                explanation: "كل الصحابة رضي الله عنهم صلوا إلى القبلتين: أولاً إلى بيت المقدس، ثم إلى الكعبة بعد تغيير القبلة."
            },
            {
                id: 73,
                question: "ما هي السورة التي تسمى 'القصص'؟",
                options: ["القصص", "يوسف", "النمل", "طه"],
                correctAnswer: 0,
                explanation: "سورة القصص تسمى بهذا الاسم لكثرة ما ورد فيها من قصص الأنبياء والأمم السابقة."
            },
            {
                id: 74,
                question: "من هو الصحابي الذي قال له النبي 'أنت مني وأنا منك'؟",
                options: ["زيد بن حارثة", "علي بن أبي طالب", "حسان بن ثابت", "العباس بن عبد المطلب"],
                correctAnswer: 0,
                explanation: "زيد بن حارثة رضي الله عنه هو الصحابي الذي قال له النبي صلى الله عليه وسلم 'أنت مني وأنا منك'."
            },
            {
                id: 75,
                question: "ما هي السورة التي تسمى 'المنجرة'؟",
                options: ["الواقعة", "القارعة", "الغاشية", "البلد"],
                correctAnswer: 0,
                explanation: "سورة الواقعة تسمى 'المنجرة' لأنها تنجي قارئها من الفقر."
            },
            {
                id: 76,
                question: "من هو الصحابي الذي دعا له النبي أن يملأ الله جوفه علماً؟",
                options: ["أبو هريرة", "عبدالله بن عمر", "أنس بن مالك", "جابر بن عبدالله"],
                correctAnswer: 0,
                explanation: "أبو هريرة رضي الله عنه دعا له النبي صلى الله عليه وسلم أن يملأ الله جوفه علماً، فكان أكثر الصحابة رواية للحديث."
            },
            {
                id: 77,
                question: "ما هي السورة التي تسمى 'الغرفة'؟",
                options: ["الزمر", "غافر", "فصلت", "الشورى"],
                correctAnswer: 0,
                explanation: "سورة الزمر تسمى 'الغرفة' لورود ذكر الغرف فيها: 'لهم غرف من فوقها غرف'."
            },
            {
                id: 78,
                question: "من هو الصحابي الذي تمنى النبي أن يراه وهو يصلي؟",
                options: ["عبدالله بن الزبير", "عبدالله بن عباس", "عبدالله بن عمر", "عبدالله بن مسعود"],
                correctAnswer: 0,
                explanation: "عبدالله بن الزبير رضي الله عنه هو الصحابي الذي تمنى النبي صلى الله عليه وسلم أن يراه وهو يصلي."
            },
            {
                id: 79,
                question: "ما هي السورة التي تسمى 'سورة النساء الطوال'؟",
                options: ["النساء", "الطلاق", "التحريم", "الممتحنة"],
                correctAnswer: 0,
                explanation: "سورة النساء تسمى 'سورة النساء الطوال' لطولها وما فيها من أحكام النساء."
            },
            {
                id: 80,
                question: "من هو الصحابي الذي كان يسمى 'حمامة المسجد'؟",
                options: ["عبدالله بن عمر", "عبدالله بن الزبير", "أنس بن مالك", "عثمان بن طلحة"],
                correctAnswer: 1,
                explanation: "عبدالله بن الزبير رضي الله عنه كان يسمى 'حمامة المسجد' لكثرة صلاته في المسجد."
            }
        ],
        
        // Level 5: Very Hard (20 questions)
        5: [
            {
                id: 81,
                question: "ما هي السورة التي تسمى 'السبع المثاني'؟",
                options: ["الفاتحة", "البقرة", "ال عمران", "النساء"],
                correctAnswer: 0,
                explanation: "سورة الفاتحة تسمى 'السبع المثاني' لأنها سبع آيات تثنى في كل ركعة من الصلاة."
            },
            {
                id: 82,
                question: "من هو الصحابي الذي كان يسمى 'بحر الأمثال'؟",
                options: ["أبو هريرة", "عبدالله بن عباس", "علي بن أبي طالب", "عمر بن الخطاب"],
                correctAnswer: 2,
                explanation: "علي بن أبي طالب رضي الله عنه كان يسمى 'بحر الأمثال' لكثرة ما ضرب من الأمثال في خطبه وكلامه."
            },
            {
                id: 83,
                question: "ما هي السورة التي تسمى 'الإنذار'؟",
                options: ["المدثر", "المزمل", "القيامة", "النازعات"],
                correctAnswer: 0,
                explanation: "سورة المدثر تسمى 'الإنذار' لأنها بدأت بالأمر بالإنذار: 'يا أيها المدثر، قم فأنذر'."
            },
            {
                id: 84,
                question: "من هو الصحابي الذي كان يسمى 'الحبر'؟",
                options: ["عبدالله بن عباس", "زيد بن ثابت", "معاذ بن جبل", "أبي بن كعب"],
                correctAnswer: 0,
                explanation: "عبدالله بن عباس رضي الله عنهما كان يسمى 'الحبر' أي العالم لكثرة علمه وفقهه."
            },
            {
                id: 85,
                question: "ما هي السورة التي تسمى 'سورة النعم'؟",
                options: ["النحل", "الأنعام", "يوسف", "الإسراء"],
                correctAnswer: 0,
                explanation: "سورة النحل تسمى 'سورة النعم' لكثرة ما ذكر فيها من نعم الله على عباده."
            },
            {
                id: 86,
                question: "من هو الصحابي الذي كان يسمى 'أسد الله'؟",
                options: ["حمزة بن عبد المطلب", "علي بن أبي طالب", "خالد بن الوليد", "الزبير بن العوام"],
                correctAnswer: 0,
                explanation: "حمزة بن عبد المطلب رضي الله عنه كان يسمى 'أسد الله' و'أسد رسوله' لشجاعته وبطولته."
            },
            {
                id: 87,
                question: "ما هي السورة التي تسمى 'القلب' في القرآن؟",
                options: ["يس", "ق", "ص", "فصلت"],
                correctAnswer: 0,
                explanation: "سورة يس تسمى 'قلب القرآن' كما جاء في بعض الأحاديث الضعيفة، ولكن اشتهرت بذلك بين الناس."
            },
            {
                id: 88,
                question: "من هو الصحابي الذي كان يسمى 'ذا النورين'؟",
                options: ["عثمان بن عفان", "طلحة بن عبيد الله", "الزبير بن العوام", "عبدالرحمن بن عوف"],
                correctAnswer: 0,
                explanation: "عثمان بن عفان رضي الله عنه كان يسمى 'ذا النورين' لأنه تزوج ابنتي النبي صلى الله عليه وسلم: رقية ثم أم كلثوم."
            },
            {
                id: 89,
                question: "ما هي السورة التي تسمى 'المنافقة'؟",
                options: ["المنافقون", "البقرة", "التوبة", "النساء"],
                correctAnswer: 2,
                explanation: "سورة التوبة تسمى 'المنافقة' لأنها نزلت في شأن المنافقين وفضحتهم."
            },
            {
                id: 90,
                question: "من هو الصحابي الذي كان يسمى 'كاتب الوحي'؟",
                options: ["زيد بن ثابت", "معاوية بن أبي سفيان", "عبدالله بن سعد بن أبي سرح", "جميع ما سبق"],
                correctAnswer: 3,
                explanation: "كل من زيد بن ثابت، ومعاوية بن أبي سفيان، وعبدالله بن سعد بن أبي سرح رضي الله عنهم كانوا من كتاب الوحي."
            },
            {
                id: 91,
                question: "ما هي السورة التي تسمى 'التوديع'؟",
                options: ["النصر", "المسد", "الإخلاص", "الفلق"],
                correctAnswer: 0,
                explanation: "سورة النصر تسمى 'التوديع' لأنها نزلت قرب وفاة النبي صلى الله عليه وسلم وكانت تبشره بقرب أجله."
            },
            {
                id: 92,
                question: "من هو الصحابي الذي كان يسمى 'فارس رسول الله'؟",
                options: ["خالد بن الوليد", "علي بن أبي طالب", "الزبير بن العوام", "أبو دجانة"],
                correctAnswer: 3,
                explanation: "أبو دجانة رضي الله عنه كان يسمى 'فارس رسول الله' لشجاعته وبطولته في المعارك."
            },
            {
                id: 93,
                question: "ما هي السورة التي تسمى 'المصابيح'؟",
                options: ["البقرة", "النور", "الأعراف", "المؤمنون"],
                correctAnswer: 1,
                explanation: "سورة النور تسمى 'المصابيح' لورود آية النور فيها: 'الله نور السماوات والأرض'."
            },
            {
                id: 94,
                question: "من هو الصحابي الذي كان يسمى 'صاحب سر رسول الله'؟",
                options: ["حذيفة بن اليمان", "أبو هريرة", "أنس بن مالك", "أسامة بن زيد"],
                correctAnswer: 0,
                explanation: "حذيفة بن اليمان رضي الله عنه كان يسمى 'صاحب سر رسول الله' لأنه كان يعلم أسماء المنافقين."
            },
            {
                id: 95,
                question: "ما هي السورة التي تسمى 'الرحمة'؟",
                options: ["الرحمن", "الأنبياء", "مريم", "الطور"],
                correctAnswer: 0,
                explanation: "سورة الرحمن تسمى 'الرحمة' لكثرة ما ورد فيها من ذكر رحمة الله تعالى."
            },
            {
                id: 96,
                question: "من هو الصحابي الذي كان يسمى 'الحكم'؟",
                options: ["علي بن أبي طالب", "عمر بن الخطاب", "معاذ بن جبل", "أبو موسى الأشعري"],
                correctAnswer: 0,
                explanation: "علي بن أبي طالب رضي الله عنه كان يسمى 'الحكم' لحسن قضائه وفصاحة كلامه."
            },
            {
                id: 97,
                question: "ما هي السورة التي تسمى 'المجادلة والمحاجة'؟",
                options: ["المجادلة", "الزخرف", "غافر", "فصلت"],
                correctAnswer: 0,
                explanation: "سورة المجادلة تسمى 'المجادلة والمحاجة' لورود قصة المرأة التي جادلت النبي صلى الله عليه وسلم."
            },
            {
                id: 98,
                question: "من هو الصحابي الذي كان يسمى 'الطيار'؟",
                options: ["جعفر بن أبي طالب", "علي بن أبي طالب", "زيد بن حارثة", "عبدالله بن رواحة"],
                correctAnswer: 0,
                explanation: "جعفر بن أبي طالب رضي الله عنه كان يسمى 'الطيار' لأنه استشهد في معركة مؤتة وقد قطعت يداه فحلقت روحه في الجنة."
            },
            {
                id: 99,
                question: "ما هي السورة التي تسمى 'المسبحات'؟",
                options: ["الحديد والحشر والصف والجمعة والتغابن والأعلى", "البقرة وآل عمران والنساء والمائدة", "الأنعام والأعراف ويونس وهود", "الإسراء والكهف ومريم وطه"],
                correctAnswer: 0,
                explanation: "المسبحات هي السور التي تبدأ بتسبيح الله: الحديد، الحشر، الصف، الجمعة، التغابن، الأعلى."
            },
            {
                id: 100,
                question: "من هو الصحابي الذي كان يسمى 'سيد الشهداء'؟",
                options: ["حمزة بن عبد المطلب", "علي بن أبي طالب", "خالد بن الوليد", "مصعب بن عمير"],
                correctAnswer: 0,
                explanation: "حمزة بن عبد المطلب رضي الله عنه كان يسمى 'سيد الشهداء' لأنه أول من استشهد في غزوة أحد وكان عم النبي صلى الله عليه وسلم."
            }
        ]
    };
    
    // Badges Database
    const badgesDatabase = [
        {
            id: 1,
            name: "شارة المبتدئ",
            description: "أكمل أول اختبار في المستوى السهل جدًا",
            icon: "fas fa-seedling",
            condition: (userData) => userData.completedLevels.includes(1) && userData.scores[1] >= 10
        },
        {
            id: 2,
            name: "شارة المجتهد",
            description: "أكمل اختبارين مختلفين بنسبة نجاح 75% على الأقل",
            icon: "fas fa-book-reader",
            condition: (userData) => {
                const completedLevels = Object.keys(userData.scores).length;
                const highScores = Object.values(userData.scores).filter(score => score >= 15).length;
                return completedLevels >= 2 && highScores >= 2;
            }
        },
        {
            id: 3,
            name: "شارة المتقدم",
            description: "أكمل المستوى المتوسط بنسبة نجاح 80% على الأقل",
            icon: "fas fa-user-graduate",
            condition: (userData) => userData.completedLevels.includes(3) && userData.scores[3] >= 16
        },
        {
            id: 4,
            name: "شارة المتفوق",
            description: "أكمل مستوى صعب بنسبة نجاح 85% على الأقل",
            icon: "fas fa-crown",
            condition: (userData) => {
                const hardLevels = [4, 5];
                return hardLevels.some(level => 
                    userData.completedLevels.includes(level) && userData.scores[level] >= 17
                );
            }
        },
        {
            id: 5,
            name: "شارة العالم الصغير",
            description: "أكمل جميع المستويات بنسبة نجاح 70% على الأقل",
            icon: "fas fa-star",
            condition: (userData) => {
                const allLevels = [1, 2, 3, 4, 5];
                const completedAll = allLevels.every(level => userData.completedLevels.includes(level));
                const allPassed = allLevels.every(level => !userData.scores[level] || userData.scores[level] >= 14);
                return completedAll && allPassed;
            }
        },
        {
            id: 6,
            name: "شارة الصابر",
            description: "أكمل اختبارًا بعد انتهاء الوقت",
            icon: "fas fa-hourglass-half",
            condition: (userData) => userData.timedOutQuizzes > 0
        },
        {
            id: 7,
            name: "شارة المتعلم",
            description: "تعلم من 10 إجابات خاطئة على الأقل",
            icon: "fas fa-lightbulb",
            condition: (userData) => userData.learnedFromMistakes >= 10
        },
        {
            id: 8,
            name: "شارة المثابر",
            description: "أكمل 3 اختبارات متتالية",
            icon: "fas fa-trophy",
            condition: (userData) => userData.consecutiveQuizzes >= 3
        }
    ];
    
    // Timer settings per level (seconds per question)
    const timerSettings = {
        1: 30, // Very Easy
        2: 25, // Easy
        3: 20, // Medium
        4: 15, // Hard
        5: 10  // Very Hard
    };
    
    // Level names
    const levelNames = {
        1: "سهل جدًا",
        2: "سهل",
        3: "متوسط",
        4: "صعب",
        5: "صعب جدًا"
    };
    
    // DOM Elements
    const screens = {
        welcome: document.getElementById('welcomeScreen'),
        levelSelection: document.getElementById('levelSelectionScreen'),
        quiz: document.getElementById('quizScreen'),
        results: document.getElementById('resultsScreen')
    };
    
    const buttons = {
        startQuiz: document.getElementById('startQuizBtn'),
        backToWelcome: document.getElementById('backToWelcome'),
        backToLevels: document.getElementById('backToLevels'),
        nextQuestion: document.getElementById('nextQuestionBtn'),
        restartQuiz: document.getElementById('restartQuizBtn'),
        viewLevels: document.getElementById('viewLevelsBtn'),
        levelSelection: document.querySelectorAll('.btn-level'),
        themeToggle: document.getElementById('themeToggle'),
        showBadges: document.getElementById('showBadgesBtn'),
        closeBadgesModal: document.getElementById('closeBadgesModal')
    };
    
    const quizElements = {
        currentLevel: document.getElementById('currentLevel'),
        currentQuestion: document.getElementById('currentQuestion'),
        totalQuestions: document.getElementById('totalQuestions'),
        currentScore: document.getElementById('currentScore'),
        timer: document.getElementById('timer'),
        timerBar: document.getElementById('timerBar'),
        questionText: document.getElementById('questionText'),
        optionsContainer: document.querySelector('.options-container'),
        nextQuestionBtn: document.getElementById('nextQuestionBtn')
    };
    
    const resultsElements = {
        finalScore: document.getElementById('finalScore'),
        percentage: document.getElementById('percentage'),
        resultTitle: document.getElementById('resultTitle'),
        resultDescription: document.getElementById('resultDescription'),
        badgesContainer: document.getElementById('badgesContainer')
    };
    
    const badgesModal = document.getElementById('badgesModal');
    
    // Initialize user data from localStorage
    let userData = JSON.parse(localStorage.getItem('islamicQuizUserData')) || {
        completedLevels: [],
        scores: {},
        badges: [],
        timedOutQuizzes: 0,
        learnedFromMistakes: 0,
        consecutiveQuizzes: 0,
        lastQuizDate: null
    };
    
    // Current quiz state
    let currentQuiz = {
        level: null,
        questions: [],
        currentQuestionIndex: 0,
        score: 0,
        correctAnswers: 0,
        userAnswers: [],
        timeLeft: 0,
        timerInterval: null,
        isCompleted: false
    };
    
    // Initialize the app
    function init() {
        // Apply saved theme
        if (appState.isDarkMode) {
            document.body.classList.add('dark-mode');
        }
        
        // Set up event listeners
        setupEventListeners();
        
        // Show welcome screen
        showScreen('welcome');
        
        // Load user badges
        loadUserBadges();
    }
    
    // Set up event listeners
    function setupEventListeners() {
        // Navigation buttons
        buttons.startQuiz.addEventListener('click', () => showScreen('levelSelection'));
        buttons.backToWelcome.addEventListener('click', () => showScreen('welcome'));
        buttons.backToLevels.addEventListener('click', () => showScreen('levelSelection'));
        buttons.restartQuiz.addEventListener('click', restartQuiz);
        buttons.viewLevels.addEventListener('click', () => showScreen('levelSelection'));
        
        // Level selection buttons
        buttons.levelSelection.forEach(button => {
            button.addEventListener('click', function() {
                const level = parseInt(this.parentElement.getAttribute('data-level'));
                startQuiz(level);
            });
        });
        
        // Next question button
        buttons.nextQuestion.addEventListener('click', nextQuestion);
        
        // Theme toggle
        buttons.themeToggle.addEventListener('click', toggleTheme);
        
        // Badges modal
        buttons.showBadges.addEventListener('click', showAllBadges);
        buttons.closeBadgesModal.addEventListener('click', () => {
            badgesModal.classList.remove('active');
        });
        
        // Close modal when clicking outside
        badgesModal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });
    }
    
    // Show a specific screen
    function showScreen(screenName) {
        // Hide all screens
        Object.values(screens).forEach(screen => {
            screen.classList.remove('active');
        });
        
        // Show the requested screen
        screens[screenName].classList.add('active');
        appState.currentScreen = screenName;
        
        // Update badges display if needed
        if (screenName === 'results') {
            updateBadgesDisplay();
        }
    }
    
    // Start a new quiz
    function startQuiz(level) {
        // Reset current quiz state
        currentQuiz = {
            level: level,
            questions: [...questionsDatabase[level]], // Create a copy of questions
            currentQuestionIndex: 0,
            score: 0,
            correctAnswers: 0,
            userAnswers: [],
            timeLeft: timerSettings[level],
            timerInterval: null,
            isCompleted: false
        };
        
        // Shuffle questions (optional, can be removed for consistency)
        shuffleArray(currentQuiz.questions);
        
        // Update UI
        quizElements.currentLevel.textContent = levelNames[level];
        quizElements.totalQuestions.textContent = currentQuiz.questions.length;
        quizElements.currentScore.textContent = currentQuiz.score;
        
        // Show quiz screen
        showScreen('quiz');
        
        // Load first question
        loadQuestion();
        
        // Start timer
        startTimer();
    }
    
    // Load current question
    function loadQuestion() {
        const question = currentQuiz.questions[currentQuiz.currentQuestionIndex];
        
        // Update UI
        quizElements.currentQuestion.textContent = currentQuiz.currentQuestionIndex + 1;
        quizElements.questionText.textContent = question.question;
        
        // Clear options container
        quizElements.optionsContainer.innerHTML = '';
        
        // Create option elements
        question.options.forEach((option, index) => {
            const optionElement = document.createElement('div');
            optionElement.className = 'option';
            optionElement.textContent = option;
            optionElement.setAttribute('data-index', index);
            
            // Add click event
            optionElement.addEventListener('click', () => selectOption(index));
            
            quizElements.optionsContainer.appendChild(optionElement);
        });
        
        // Reset next button
        quizElements.nextQuestionBtn.disabled = true;
        
        // Reset timer
        resetTimer();
    }
    
    // Select an option
    function selectOption(selectedIndex) {
        // Prevent multiple selections
        if (currentQuiz.userAnswers[currentQuiz.currentQuestionIndex] !== undefined) {
            return;
        }
        
        const question = currentQuiz.questions[currentQuiz.currentQuestionIndex];
        const options = document.querySelectorAll('.option');
        
        // Store user answer
        currentQuiz.userAnswers[currentQuiz.currentQuestionIndex] = selectedIndex;
        
        // Disable all options
        options.forEach(option => {
            option.style.pointerEvents = 'none';
        });
        
        // Mark selected option
        const selectedOption = options[selectedIndex];
        selectedOption.classList.add('selected');
        
        // Check if answer is correct
        if (selectedIndex === question.correctAnswer) {
            selectedOption.classList.add('correct');
            
            // Update score
            const pointsPerQuestion = 100 + (currentQuiz.level * 50);
            currentQuiz.score += pointsPerQuestion;
            currentQuiz.correctAnswers++;
            
            quizElements.currentScore.textContent = currentQuiz.score;
        } else {
            selectedOption.classList.add('incorrect');
            
            // Highlight correct answer
            const correctOption = options[question.correctAnswer];
            correctOption.classList.add('correct');
            correctOption.innerHTML += ' <span class="correct-answer"><i class="fas fa-check-circle"></i> الإجابة الصحيحة</span>';
            
            // Track learning from mistakes
            userData.learnedFromMistakes++;
            localStorage.setItem('islamicQuizUserData', JSON.stringify(userData));
        }
        
        // Enable next button
        quizElements.nextQuestionBtn.disabled = false;
    }
    
    // Move to next question
    function nextQuestion() {
        // Stop current timer
        if (currentQuiz.timerInterval) {
            clearInterval(currentQuiz.timerInterval);
        }
        
        // Move to next question
        currentQuiz.currentQuestionIndex++;
        
        // Check if quiz is completed
        if (currentQuiz.currentQuestionIndex >= currentQuiz.questions.length) {
            completeQuiz();
        } else {
            // Load next question
            loadQuestion();
            startTimer();
        }
    }
    
    // Complete the quiz
    function completeQuiz() {
        // Stop timer
        if (currentQuiz.timerInterval) {
            clearInterval(currentQuiz.timerInterval);
        }
        
        currentQuiz.isCompleted = true;
        
        // Calculate results
        const totalQuestions = currentQuiz.questions.length;
        const percentage = Math.round((currentQuiz.correctAnswers / totalQuestions) * 100);
        
        // Update results UI
        resultsElements.finalScore.textContent = currentQuiz.correctAnswers;
        resultsElements.percentage.textContent = `${percentage}%`;
        
        // Set result message based on performance
        let title, description;
        
        if (percentage >= 90) {
            title = "متفوق بارع!";
            description = "أحسنت! لديك معرفة إسلامية ممتازة. استمر في التعلم ونشر العلم.";
        } else if (percentage >= 75) {
            title = "جيد جدًا!";
            description = "أداء ممتاز! لديك معرفة جيدة بالعلوم الإسلامية. واصل التعلم لتطوير معلوماتك.";
        } else if (percentage >= 60) {
            title = "مقبول!";
            description = "ليس سيئًا! لديك معرفة أساسية جيدة. راجع المعلومات وكرر الاختبار لتحسين نتيجتك.";
        } else if (percentage >= 50) {
            title = "يحتاج إلى تحسين";
            description = "لديك بعض المعلومات الأساسية. ننصحك بمراجعة الكتب الإسلامية الأساسية وتحسين معرفتك.";
        } else {
            title = "يحتاج إلى جهد أكبر";
            description = "معرفتك الإسلامية تحتاج إلى تحسين. ابدأ بتعلم الأساسيات وكرر الاختبار بعد فترة.";
        }
        
        resultsElements.resultTitle.textContent = title;
        resultsElements.resultDescription.textContent = description;
        
        // Update user data
        if (!userData.completedLevels.includes(currentQuiz.level)) {
            userData.completedLevels.push(currentQuiz.level);
        }
        
        userData.scores[currentQuiz.level] = currentQuiz.correctAnswers;
        
        // Update consecutive quizzes
        const today = new Date().toDateString();
        if (userData.lastQuizDate === today) {
            userData.consecutiveQuizzes++;
        } else {
            userData.consecutiveQuizzes = 1;
        }
        userData.lastQuizDate = today;
        
        // Check for new badges
        checkForNewBadges();
        
        // Save user data
        localStorage.setItem('islamicQuizUserData', JSON.stringify(userData));
        
        // Show results screen
        showScreen('results');
    }
    
    // Timer functions
    function startTimer() {
        currentQuiz.timeLeft = timerSettings[currentQuiz.level];
        updateTimerDisplay();
        
        currentQuiz.timerInterval = setInterval(() => {
            currentQuiz.timeLeft--;
            updateTimerDisplay();
            
            if (currentQuiz.timeLeft <= 0) {
                timeUp();
            }
        }, 1000);
    }
    
    function resetTimer() {
        currentQuiz.timeLeft = timerSettings[currentQuiz.level];
        updateTimerDisplay();
    }
    
    function updateTimerDisplay() {
        quizElements.timer.textContent = currentQuiz.timeLeft;
        
        // Update timer bar width
        const totalTime = timerSettings[currentQuiz.level];
        const percentage = (currentQuiz.timeLeft / totalTime) * 100;
        quizElements.timerBar.style.width = `${percentage}%`;
        
        // Change color based on time left
        if (percentage <= 25) {
            quizElements.timerBar.style.backgroundColor = '#dc3545'; // Red
        } else if (percentage <= 50) {
            quizElements.timerBar.style.backgroundColor = '#ffc107'; // Yellow
        } else {
            quizElements.timerBar.style.backgroundColor = 'var(--primary-color)';
        }
    }
    
    function timeUp() {
        // Stop timer
        clearInterval(currentQuiz.timerInterval);
        
        // Mark all unanswered questions as incorrect
        if (currentQuiz.userAnswers[currentQuiz.currentQuestionIndex] === undefined) {
            const options = document.querySelectorAll('.option');
            const question = currentQuiz.questions[currentQuiz.currentQuestionIndex];
            
            // Disable all options
            options.forEach(option => {
                option.style.pointerEvents = 'none';
            });
            
            // Highlight correct answer
            const correctOption = options[question.correctAnswer];
            correctOption.classList.add('correct');
            correctOption.innerHTML += ' <span class="correct-answer"><i class="fas fa-check-circle"></i> الإجابة الصحيحة</span>';
            
            // Store as unanswered
            currentQuiz.userAnswers[currentQuiz.currentQuestionIndex] = null;
            
            // Track timeout
            userData.timedOutQuizzes++;
            localStorage.setItem('islamicQuizUserData', JSON.stringify(userData));
        }
        
        // Enable next button
        quizElements.nextQuestionBtn.disabled = false;
    }
    
    // Restart quiz
    function restartQuiz() {
        if (currentQuiz.level) {
            startQuiz(currentQuiz.level);
        } else {
            showScreen('levelSelection');
        }
    }
    
    // Theme toggle
    function toggleTheme() {
        appState.isDarkMode = !appState.isDarkMode;
        document.body.classList.toggle('dark-mode', appState.isDarkMode);
        localStorage.setItem('isDarkMode', appState.isDarkMode);
    }
    
    // Badges functions
    function checkForNewBadges() {
        const earnedBadges = [];
        
        badgesDatabase.forEach(badge => {
            // Skip if already earned
            if (userData.badges.includes(badge.id)) return;
            
            // Check if badge is earned
            if (badge.condition(userData)) {
                userData.badges.push(badge.id);
                earnedBadges.push(badge);
            }
        });
        
        // Save updated badges
        localStorage.setItem('islamicQuizUserData', JSON.stringify(userData));
        
        // Show notification for new badges
        if (earnedBadges.length > 0) {
            showBadgesEarnedNotification(earnedBadges);
        }
    }
    
    function loadUserBadges() {
        // This function is called on init to load badges
        // The actual display happens in updateBadgesDisplay()
    }
    
    function updateBadgesDisplay() {
        // Clear badges container
        resultsElements.badgesContainer.innerHTML = '';
        
        // Display earned badges
        userData.badges.forEach(badgeId => {
            const badge = badgesDatabase.find(b => b.id === badgeId);
            if (badge) {
                const badgeElement = document.createElement('div');
                badgeElement.className = 'badge earned';
                badgeElement.innerHTML = `
                    <i class="${badge.icon}"></i>
                    <span>${badge.name}</span>
                `;
                resultsElements.badgesContainer.appendChild(badgeElement);
            }
        });
        
        // If no badges earned yet
        if (userData.badges.length === 0) {
            resultsElements.badgesContainer.innerHTML = `
                <div class="no-badges">
                    <p>لم تحصل على أي شارات بعد. أكمل المزيد من الاختبارات لتحصل على شارات!</p>
                </div>
            `;
        }
        
        // Update all badges modal
        updateAllBadgesModal();
    }
    
    function showAllBadges() {
        updateAllBadgesModal();
        badgesModal.classList.add('active');
    }
    
    function updateAllBadgesModal() {
        const allBadgesContainer = document.querySelector('.all-badges');
        allBadgesContainer.innerHTML = '';
        
        badgesDatabase.forEach(badge => {
            const isEarned = userData.badges.includes(badge.id);
            
            const badgeCard = document.createElement('div');
            badgeCard.className = `badge-card ${isEarned ? 'earned' : ''}`;
            badgeCard.innerHTML = `
                <div class="badge-icon">
                    <i class="${badge.icon}"></i>
                </div>
                <h4>${badge.name}</h4>
                <p>${badge.description}</p>
                <div class="badge-requirements">
                    ${isEarned ? '<i class="fas fa-check-circle"></i> حصلت على هذه الشارة' : '<i class="fas fa-lock"></i> لم تحصل عليها بعد'}
                </div>
            `;
            
            allBadgesContainer.appendChild(badgeCard);
        });
    }
    
    function showBadgesEarnedNotification(earnedBadges) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'badge-notification';
        notification.innerHTML = `
            <div class="notification-content">
                <h3><i class="fas fa-medal"></i> أحسنت! حصلت على شارات جديدة</h3>
                <div class="earned-badges-list">
                    ${earnedBadges.map(badge => `
                        <div class="earned-badge">
                            <i class="${badge.icon}"></i>
                            <span>${badge.name}</span>
                        </div>
                    `).join('')}
                </div>
                <button class="btn-primary close-notification">حسناً</button>
            </div>
        `;
        
        // Add styles for notification
        const style = document.createElement('style');
        style.textContent = `
            .badge-notification {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 3000;
                animation: fadeIn 0.3s ease;
            }
            
            .notification-content {
                background-color: var(--card-bg);
                padding: 2rem;
                border-radius: var(--border-radius);
                max-width: 500px;
                width: 90%;
                text-align: center;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            }
            
            .notification-content h3 {
                color: var(--primary-color);
                margin-bottom: 1.5rem;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }
            
            .earned-badges-list {
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }
            
            .earned-badge {
                display: flex;
                align-items: center;
                gap: 10px;
                background-color: rgba(212, 175, 55, 0.2);
                padding: 1rem;
                border-radius: var(--border-radius);
                border: 2px solid var(--accent-color);
            }
            
            .earned-badge i {
                color: var(--accent-color);
                font-size: 1.5rem;
            }
            
            .earned-badge span {
                font-weight: 600;
                color: var(--text-color);
            }
            
            .close-notification {
                margin-top: 1rem;
            }
        `;
        
        document.head.appendChild(style);
        document.body.appendChild(notification);
        
        // Add close event
        notification.querySelector('.close-notification').addEventListener('click', () => {
            document.body.removeChild(notification);
            document.head.removeChild(style);
        });
    }
    
    // Utility functions
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
    
    // Initialize the application
    init();
});
